(function(e){if(typeof define==="function"&&define.amd){define(["jquery"],e)}else if(typeof exports==="object"){e(require("jquery"))}else{e(jQuery)}})(function(e){"use strict";var t=e(window),n=e(document),r=window.location,i=true,s=false,o=null,u=NaN,a=Infinity,f="undefined",l="directive",c=".cropper",h=/^(e|n|w|s|ne|nw|sw|se|all|crop|move|zoom)$/,p=/^(x|y|width|height)$/,d=/^(naturalWidth|naturalHeight|width|height|aspectRatio|ratio|rotate)$/,v="cropper-modal",m="cropper-hidden",g="cropper-invisible",y="cropper-move",b="cropper-crop",w="cropper-disabled",E="mousedown touchstart",S="mousemove touchmove",x="mouseup mouseleave touchend touchleave touchcancel",T="wheel mousewheel DOMMouseScroll",N="resize"+c,C="dblclick",k="build"+c,L="built"+c,A="dragstart"+c,O="dragmove"+c,M="dragend"+c,_=function(e){return typeof e==="number"},D=function(e,t){var n=[];if(typeof t==="number"){n.push(t)}return n.slice.apply(e,n)},P=function(e,t){var n=D(arguments,2);return function(){return e.apply(t,n.concat(D(arguments)))}},H=function(e){var t="timestamp="+(new Date).getTime();return e+(e.indexOf("?")===-1?"?":"&")+t},B=function(t,n){this.element=t;this.$element=e(t);this.defaults=e.extend({},B.DEFAULTS,e.isPlainObject(n)?n:{});this.$original=o;this.ready=s;this.built=s;this.cropped=s;this.rotated=s;this.disabled=s;this.replaced=s;this.init()},j=Math.sqrt,F=Math.min,I=Math.max,q=Math.abs,R=Math.sin,U=Math.cos,z=parseFloat;B.prototype={constructor:B,support:{canvas:e.isFunction(e("<canvas>")[0].getContext)},init:function(){var t=this.defaults;e.each(t,function(e,n){switch(e){case"aspectRatio":t[e]=q(z(n))||u;break;case"autoCropArea":t[e]=q(z(n))||.8;break;case"minWidth":case"minHeight":t[e]=q(z(n))||0;break;case"maxWidth":case"maxHeight":t[e]=q(z(n))||a;break}});this.image={rotate:0};this.load()},load:function(){var t=this,n=this.$element,r=this.element,s=this.image,o="",u,a;if(n.is("img")){a=n.prop("src")}else if(n.is("canvas")&&this.support.canvas){a=r.toDataURL()}if(!a){return}if(this.replaced){s.rotate=0}if(this.defaults.checkImageOrigin){if(n.prop("crossOrigin")||this.isCrossOriginURL(a)){o=" crossOrigin";a=H(a)}}this.$clone=u=e("<img"+o+' src="'+a+'">');u.one("load",function(){s.naturalWidth=this.naturalWidth||u.width();s.naturalHeight=this.naturalHeight||u.height();s.aspectRatio=s.naturalWidth/s.naturalHeight;t.url=a;t.ready=i;t.build()});u.addClass(g).prependTo("body")},isCrossOriginURL:function(e){var t=e.match(/^(https?:)\/\/([^\:\/\?#]+):?(\d*)/i);if(t&&(t[1]!==r.protocol||t[2]!==r.hostname||t[3]!==r.port)){return i}return s},build:function(){var t=this.$element,n=this.defaults,r,o;if(!this.ready){return}if(this.built){this.unbuild()}t.one(k,n.build);r=e.Event(k);t.trigger(r);if(r.isDefaultPrevented()){return}this.$cropper=o=e(B.TEMPLATE);t.addClass(m);this.$clone.removeClass(g).prependTo(o);if(!this.rotated){this.$original=this.$clone.clone();this.$original.addClass(m).prependTo(this.$cropper);this.originalImage=e.extend({},this.image)}this.$container=t.parent();this.$container.append(o);this.$canvas=o.find(".cropper-canvas");this.$dragger=o.find(".cropper-dragger");this.$viewer=o.find(".cropper-viewer");n.autoCrop?this.cropped=i:this.$dragger.addClass(m);n.modal&&this.$canvas.addClass(v);!n.dashed&&this.$dragger.find(".cropper-dashed").addClass(m);!n.movable&&this.$dragger.find(".cropper-face").data(l,"move");!n.resizable&&this.$dragger.find(".cropper-line, .cropper-point").addClass(m);this.addListeners();this.initPreview();this.built=i;n.dragCrop&&this.setDragMode("crop");this.update();this.replaced=s;t.one(L,n.built);t.trigger(L)},unbuild:function(){if(!this.built){return}this.built=s;this.removeListeners();this.$preview.empty();this.$preview=o;this.$dragger=o;this.$canvas=o;this.$container=o;this.$cropper.remove();this.$cropper=o},update:function(e){this.initContainer();this.initCropper();this.initImage();this.initDragger();if(e){this.setData(e,i);this.setDragMode("crop")}else{this.setData(this.defaults.data)}},resize:function(){clearTimeout(this.resizing);this.resizing=setTimeout(e.proxy(this.update,this,this.getData()),200)},preview:function(){var t=this.image,n=this.dragger,r=t.width,i=t.height,s=n.left-t.left,o=n.top-t.top;this.$viewer.find("img").css({width:r,height:i,marginLeft:-s,marginTop:-o});this.$preview.each(function(){var t=e(this),u=t.width()/n.width;t.find("img").css({width:r*u,height:i*u,marginLeft:-s*u,marginTop:-o*u})})},addListeners:function(){var r=this.defaults;this.$element.on(A,r.dragstart).on(O,r.dragmove).on(M,r.dragend);this.$cropper.on(E,e.proxy(this.dragstart,this)).on(C,e.proxy(this.dblclick,this));if(r.zoomable){this.$cropper.on(T,e.proxy(this.wheel,this))}if(r.multiple){this.$cropper.on(S,e.proxy(this.dragmove,this)).on(x,e.proxy(this.dragend,this))}else{n.on(S,this._dragmove=P(this.dragmove,this)).on(x,this._dragend=P(this.dragend,this))}t.on(N,this._resize=P(this.resize,this))},removeListeners:function(){var e=this.defaults;this.$element.off(A,e.dragstart).off(O,e.dragmove).off(M,e.dragend);this.$cropper.off(E,this.dragstart).off(C,this.dblclick);if(e.zoomable){this.$cropper.off(T,this.wheel)}if(e.multiple){this.$cropper.off(S,this.dragmove).off(x,this.dragend)}else{n.off(S,this._dragmove).off(x,this._dragend)}t.off(N,this._resize)},initPreview:function(){var t='<img src="'+this.url+'">';this.$preview=e(this.defaults.preview);this.$viewer.html(t);this.$preview.html(t).find("img").css("cssText","min-width:0!important;min-height:0!important;max-width:none!important;max-height:none!important;")},initContainer:function(){var e=this.$container;this.container={width:I(e.width(),this.defaults.minContainerWidth),height:I(e.height(),this.defaults.minContainerHeight)}},initCropper:function(){var e=this.container,t=this.image,n;if(t.naturalWidth*e.height/t.naturalHeight-e.width>=0){n={width:e.width,height:e.width/t.aspectRatio,left:0};n.top=(e.height-n.height)/2}else{n={width:e.height*t.aspectRatio,height:e.height,top:0};n.left=(e.width-n.width)/2}this.$cropper.css({width:n.width,height:n.height,left:n.left,top:n.top});this.cropper=n},initImage:function(){var t=this.image,n=this.cropper,r={_width:n.width,_height:n.height,width:n.width,height:n.height,left:0,top:0,ratio:n.width/t.naturalWidth};this.defaultImage=e.extend({},t,r);if(t._width!==n.width||t._height!==n.height){e.extend(t,r)}else{t=e.extend({},r,t);if(this.replaced){t.ratio=r.ratio}}this.image=t;this.renderImage()},renderImage:function(e){var t=this.image;if(e==="zoom"){t.left-=(t.width-t.oldWidth)/2;t.top-=(t.height-t.oldHeight)/2}t.left=F(I(t.left,t._width-t.width),0);t.top=F(I(t.top,t._height-t.height),0);this.$clone.css({width:t.width,height:t.height,marginLeft:t.left,marginTop:t.top});if(e){this.defaults.done(this.getData());this.preview()}},initDragger:function(){var t=this.defaults,n=this.cropper,r=t.aspectRatio||this.image.aspectRatio,i=this.image.ratio,s,o;if(n.height*r-n.width>=0){o={height:n.width/r,width:n.width,left:0,top:(n.height-n.width/r)/2,maxWidth:n.width,maxHeight:n.width/r}}else{o={height:n.height,width:n.height*r,left:(n.width-n.height*r)/2,top:0,maxWidth:n.height*r,maxHeight:n.height}}o.minWidth=0;o.minHeight=0;if(t.aspectRatio){if(isFinite(t.maxWidth)){o.maxWidth=F(o.maxWidth,t.maxWidth*i);o.maxHeight=o.maxWidth/r}else if(isFinite(t.maxHeight)){o.maxHeight=F(o.maxHeight,t.maxHeight*i);o.maxWidth=o.maxHeight*r}if(t.minWidth>0){o.minWidth=I(0,t.minWidth*i);o.minHeight=o.minWidth/r}else if(t.minHeight>0){o.minHeight=I(0,t.minHeight*i);o.minWidth=o.minHeight*r}}else{o.maxWidth=F(o.maxWidth,t.maxWidth*i);o.maxHeight=F(o.maxHeight,t.maxHeight*i);o.minWidth=I(0,t.minWidth*i);o.minHeight=I(0,t.minHeight*i)}o.minWidth=F(o.maxWidth,o.minWidth);o.minHeight=F(o.maxHeight,o.minHeight);s=e.extend({},o);s.height=o.height*t.autoCropArea;s.width=o.width*t.autoCropArea;s.left=(n.width-s.width)/2;s.top=(n.height-s.height)/2;s.oldLeft=o.oldLeft=o.left;s.oldTop=o.oldTop=o.top;this.autoCropDragger=s;this.defaultDragger=e.extend({},o);this.dragger=o},renderDragger:function(){var e=this.dragger,t=this.cropper;if(e.width>e.maxWidth){e.width=e.maxWidth;e.left=e.oldLeft}else if(e.width<e.minWidth){e.width=e.minWidth;e.left=e.oldLeft}if(e.height>e.maxHeight){e.height=e.maxHeight;e.top=e.oldTop}else if(e.height<e.minHeight){e.height=e.minHeight;e.top=e.oldTop}e.left=F(I(e.left,0),t.width-e.width);e.top=F(I(e.top,0),t.height-e.height);e.oldLeft=e.left;e.oldTop=e.top;this.dragger=e;if(!this.disabled){this.defaults.done(this.getData())}this.$dragger.css({width:e.width,height:e.height,left:e.left,top:e.top});this.preview()},reset:function(t){if(!this.cropped){return}if(t){this.defaults.data={}}this.image=e.extend({},this.defaultImage);this.renderImage();this.dragger=e.extend({},this.defaultDragger);this.setData(this.defaults.data)},clear:function(){if(!this.cropped){return}this.cropped=s;this.setData({x:0,y:0,width:0,height:0});this.$canvas.removeClass(v);this.$dragger.addClass(m)},destroy:function(){var e=this.$element;if(!this.ready){return}this.unbuild();e.removeClass(m).removeData("cropper");if(this.rotated){e.attr("src",this.$original.attr("src"))}},replace:function(t,n){var r=this,o=this.$element,u=this.element,a;if(t&&t!==this.url&&t!==o.attr("src")){if(!n){this.rotated=s;this.replaced=i}if(o.is("img")){o.attr("src",t);this.load()}else if(o.is("canvas")&&this.support.canvas){a=u.getContext("2d");e('<img src="'+t+'">').one("load",function(){u.width=this.width;u.height=this.height;a.clearRect(0,0,u.width,u.height);a.drawImage(this,0,0);r.load()})}}},setData:function(t,n){var r=this.cropper,i=this.dragger,s=this.image,u=this.defaults.aspectRatio;if(!this.built||typeof t===f){return}if(t===o||e.isEmptyObject(t)){i=e.extend({},this.autoCropDragger)}if(e.isPlainObject(t)&&!e.isEmptyObject(t)){if(!n){this.defaults.data=t}t=this.transformData(t);if(_(t.x)&&t.x<=r.width-s.left){i.left=t.x+s.left}if(_(t.y)&&t.y<=r.height-s.top){i.top=t.y+s.top}if(u){if(_(t.width)&&t.width<=i.maxWidth&&t.width>=i.minWidth){i.width=t.width;i.height=i.width/u}else if(_(t.height)&&t.height<=i.maxHeight&&t.height>=i.minHeight){i.height=t.height;i.width=i.height*u}}else{if(_(t.width)&&t.width<=i.maxWidth&&t.width>=i.minWidth){i.width=t.width}if(_(t.height)&&t.height<=i.maxHeight&&t.height>=i.minHeight){i.height=t.height}}}this.dragger=i;this.renderDragger()},getData:function(e){var t=this.dragger,n=this.image,r={};if(this.built){r={x:t.left-n.left,y:t.top-n.top,width:t.width,height:t.height};r=this.transformData(r,i,e)}return r},transformData:function(t,n,r){var i=this.image.ratio,s={};e.each(t,function(e,t){t=z(t);if(p.test(e)&&!isNaN(t)){s[e]=n?r?Math.round(t/i):t/i:t*i}});return s},setAspectRatio:function(e){var t=e==="auto";e=z(e);if(t||!isNaN(e)&&e>0){this.defaults.aspectRatio=t?u:e;if(this.built){this.initDragger();this.renderDragger();this.setData(this.defaults.data)}}},getImageData:function(){var t={};if(this.ready){e.each(this.image,function(e,n){if(d.test(e)){t[e]=n}})}return t},getDataURL:function(t,n,r){var i=e("<canvas>")[0],s=this.getData(),o="",u;if(!e.isPlainObject(t)){r=n;n=t;t={}}t=e.extend({width:s.width,height:s.height},t);if(this.cropped&&this.support.canvas){i.width=t.width;i.height=t.height;u=i.getContext("2d");if(n==="image/jpeg"){u.fillStyle="#fff";u.fillRect(0,0,t.width,t.height)}u.drawImage(this.$clone[0],s.x,s.y,s.width,s.height,0,0,t.width,t.height);o=i.toDataURL(n,r)}return o},setDragMode:function(e){var t=this.$canvas,n=this.defaults,r=s,o=s;if(!this.built||this.disabled){return}switch(e){case"crop":if(n.dragCrop){r=i;t.data(l,e)}break;case"move":o=i;t.data(l,e);break;default:t.removeData(l)}t.toggleClass(b,r).toggleClass(y,o)},enable:function(){if(this.built){this.disabled=s;this.$cropper.removeClass(w)}},disable:function(){if(this.built){this.disabled=i;this.$cropper.addClass(w)}},rotate:function(e){var t=this.image;e=z(e)||0;if(!this.built||e===0||this.disabled||!this.defaults.rotatable||!this.support.canvas){return}this.rotated=i;e=t.rotate=(t.rotate+e)%360;this.replace(this.getRotatedDataURL(e),true)},getRotatedDataURL:function(t){var n=e("<canvas>")[0],r=n.getContext("2d"),i=t*Math.PI/180,s=q(t)%180,o=s>90?180-s:s,u=o*Math.PI/180,a=this.originalImage,f=a.naturalWidth,l=a.naturalHeight,c=q(f*U(u)+l*R(u)),h=q(f*R(u)+l*U(u));n.width=c;n.height=h;r.save();r.translate(c/2,h/2);r.rotate(i);r.drawImage(this.$original[0],-f/2,-l/2,f,l);r.restore();return n.toDataURL()},zoom:function(e){var t=this.image,n,r,i;e=z(e);if(!this.built||!e||this.disabled||!this.defaults.zoomable){return}n=t.width*(1+e);r=t.height*(1+e);i=n/t._width;if(i>10){return}if(i<1){n=t._width;r=t._height}if(i<=1){this.setDragMode("crop")}else{this.setDragMode("move")}t.oldWidth=t.width;t.oldHeight=t.height;t.width=n;t.height=r;t.ratio=t.width/t.naturalWidth;this.renderImage("zoom")},dblclick:function(){if(this.disabled){return}if(this.$canvas.hasClass(b)){this.setDragMode("move")}else{this.setDragMode("crop")}},wheel:function(e){var t=e.originalEvent,n=117.25,r=5,i=166.66665649414062,s=.1,o;if(this.disabled){return}e.preventDefault();if(t.deltaY){o=t.deltaY;o=o%r===0?o/r:o%n===0?o/n:o/i}else{o=t.wheelDelta?-t.wheelDelta/120:t.detail?t.detail/3:0}this.zoom(o*s)},dragstart:function(t){var n=t.originalEvent.touches,r=t,o,u,a;if(this.disabled){return}if(n){a=n.length;if(a>1){if(this.defaults.zoomable&&a===2){r=n[1];this.startX2=r.pageX;this.startY2=r.pageY;o="zoom"}else{return}}r=n[0]}o=o||e(r.target).data(l);if(h.test(o)){t.preventDefault();u=e.Event(A);this.$element.trigger(u);if(u.isDefaultPrevented()){return}this.directive=o;this.cropping=s;this.startX=r.pageX;this.startY=r.pageY;if(o==="crop"){this.cropping=i;this.$canvas.addClass(v)}}},dragmove:function(t){var n=t.originalEvent.touches,r=t,i,s;if(this.disabled){return}if(n){s=n.length;if(s>1){if(this.defaults.zoomable&&s===2){r=n[1];this.endX2=r.pageX;this.endY2=r.pageY}else{return}}r=n[0]}if(this.directive){t.preventDefault();i=e.Event(O);this.$element.trigger(i);if(i.isDefaultPrevented()){return}this.endX=r.pageX;this.endY=r.pageY;this.dragging()}},dragend:function(t){var n;if(this.disabled){return}if(this.directive){t.preventDefault();n=e.Event(M);this.$element.trigger(n);if(n.isDefaultPrevented()){return}if(this.cropping){this.cropping=s;this.$canvas.toggleClass(v,this.cropped&&this.defaults.modal)}this.directive=""}},dragging:function(){var e=this.directive,t=this.image,n=this.cropper,r=n.width,o=n.height,u=this.dragger,a=u.width,f=u.height,l=u.left,c=u.top,h=l+a,p=c+f,d=i,v=this.defaults,g=v.aspectRatio,y={x:this.endX-this.startX,y:this.endY-this.startY},b;if(g){y.X=y.y*g;y.Y=y.x/g}switch(e){case"all":l+=y.x;c+=y.y;break;case"e":if(y.x>=0&&(h>=r||g&&(c<=0||p>=o))){d=s;break}a+=y.x;if(g){f=a/g;c-=y.Y/2}if(a<0){e="w";a=0}break;case"n":if(y.y<=0&&(c<=0||g&&(l<=0||h>=r))){d=s;break}f-=y.y;c+=y.y;if(g){a=f*g;l+=y.X/2}if(f<0){e="s";f=0}break;case"w":if(y.x<=0&&(l<=0||g&&(c<=0||p>=o))){d=s;break}a-=y.x;l+=y.x;if(g){f=a/g;c+=y.Y/2}if(a<0){e="e";a=0}break;case"s":if(y.y>=0&&(p>=o||g&&(l<=0||h>=r))){d=s;break}f+=y.y;if(g){a=f*g;l-=y.X/2}if(f<0){e="n";f=0}break;case"ne":if(g){if(y.y<=0&&(c<=0||h>=r)){d=s;break}f-=y.y;c+=y.y;a=f*g}else{if(y.x>=0){if(h<r){a+=y.x}else if(y.y<=0&&c<=0){d=s}}else{a+=y.x}if(y.y<=0){if(c>0){f-=y.y;c+=y.y}}else{f-=y.y;c+=y.y}}if(f<0){e="sw";f=0;a=0}break;case"nw":if(g){if(y.y<=0&&(c<=0||l<=0)){d=s;break}f-=y.y;c+=y.y;a=f*g;l+=y.X}else{if(y.x<=0){if(l>0){a-=y.x;l+=y.x}else if(y.y<=0&&c<=0){d=s}}else{a-=y.x;l+=y.x}if(y.y<=0){if(c>0){f-=y.y;c+=y.y}}else{f-=y.y;c+=y.y}}if(f<0){e="se";f=0;a=0}break;case"sw":if(g){if(y.x<=0&&(l<=0||p>=o)){d=s;break}a-=y.x;l+=y.x;f=a/g}else{if(y.x<=0){if(l>0){a-=y.x;l+=y.x}else if(y.y>=0&&p>=o){d=s}}else{a-=y.x;l+=y.x}if(y.y>=0){if(p<o){f+=y.y}}else{f+=y.y}}if(a<0){e="ne";f=0;a=0}break;case"se":if(g){if(y.x>=0&&(h>=r||p>=o)){d=s;break}a+=y.x;f=a/g}else{if(y.x>=0){if(h<r){a+=y.x}else if(y.y>=0&&p>=o){d=s}}else{a+=y.x}if(y.y>=0){if(p<o){f+=y.y}}else{f+=y.y}}if(a<0){e="nw";f=0;a=0}break;case"move":t.left+=y.x;t.top+=y.y;this.renderImage("move");d=s;break;case"zoom":if(v.zoomable){this.zoom(function(e,t,n,r,i,s){return(j(i*i+s*s)-j(n*n+r*r))/j(e*e+t*t)}(t.width,t.height,q(this.startX-this.startX2),q(this.startY-this.startY2),q(this.endX-this.endX2),q(this.endY-this.endY2)));this.endX2=this.startX2;this.endY2=this.startY2}break;case"crop":if(y.x&&y.y){b=this.$cropper.offset();l=this.startX-b.left;c=this.startY-b.top;a=u.minWidth;f=u.minHeight;if(y.x>0){if(y.y>0){e="se"}else{e="ne";c-=f}}else{if(y.y>0){e="sw";l-=a}else{e="nw";l-=a;c-=f}}if(!this.cropped){this.cropped=i;this.$dragger.removeClass(m)}}break}if(d){u.width=a;u.height=f;u.left=l;u.top=c;this.directive=e;this.renderDragger()}this.startX=this.endX;this.startY=this.endY}};B.TEMPLATE=function(e,t){t=t.split(",");return e.replace(/\d+/g,function(e){return t[e]})}('<0 6="5-container"><0 6="5-canvas"></0><0 6="5-dragger"><1 6="5-viewer"></1><1 6="5-8 8-h"></1><1 6="5-8 8-v"></1><1 6="5-face" 3-2="all"></1><1 6="5-7 7-e" 3-2="e"></1><1 6="5-7 7-n" 3-2="n"></1><1 6="5-7 7-w" 3-2="w"></1><1 6="5-7 7-s" 3-2="s"></1><1 6="5-4 4-e" 3-2="e"></1><1 6="5-4 4-n" 3-2="n"></1><1 6="5-4 4-w" 3-2="w"></1><1 6="5-4 4-s" 3-2="s"></1><1 6="5-4 4-ne" 3-2="ne"></1><1 6="5-4 4-nw" 3-2="nw"></1><1 6="5-4 4-sw" 3-2="sw"></1><1 6="5-4 4-se" 3-2="se"></1></0></0>',"div,span,directive,data,point,cropper,class,line,dashed");B.DEFAULTS={aspectRatio:"auto",autoCropArea:.8,data:{},done:e.noop,preview:"",multiple:s,autoCrop:i,dragCrop:i,dashed:i,modal:i,movable:i,resizable:i,zoomable:i,rotatable:i,checkImageOrigin:i,minWidth:0,minHeight:0,maxWidth:a,maxHeight:a,minContainerWidth:300,minContainerHeight:150,build:o,built:o,dragstart:o,dragmove:o,dragend:o};B.setDefaults=function(t){e.extend(B.DEFAULTS,t)};B.other=e.fn.cropper;e.fn.cropper=function(t){var n=D(arguments,1),r;this.each(function(){var i=e(this),s=i.data("cropper"),o;if(!s){i.data("cropper",s=new B(this,t))}if(typeof t==="string"&&e.isFunction(o=s[t])){r=o.apply(s,n)}});return typeof r!==f?r:this};e.fn.cropper.Constructor=B;e.fn.cropper.setDefaults=B.setDefaults;e.fn.cropper.noConflict=function(){e.fn.cropper=B.other;return this}})
